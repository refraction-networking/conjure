version: '3'
services:
  zbalance:
    &config
    image: conjure:latest
    # image: conjure_zbalance:latest # for smaller image when running separate
    privileged: true
    network_mode: "host"
    ipc: "host"
    cap_add:
    - ipc_lock
    volumes:
    - /dev/hugepages:/dev/hugepages # zbalance_ipc
    - /etc/pf_ring:/etc/pf_ring # pf_ring licenses
    - /var/lib/conjure:/var/lib/conjure # config
    logging:
      driver: "journald"
    restart: "always"
    # command: ["bash", "-c", "zbalance_ipc -c 99 -n 4 -m1 -g 1 -i zc:enp5s0f0,zc:enp5s0f1"]
    command: ["/opt/conjure/bin/start_zbalance_ipc.sh"]

# # DEBUG PF_RING / zbalance
#  zcount:
#    << : *config
#    privileged: false
#    command: ["bash", "-c", "sleep 10 && zcount_ipc -c 99 -i 0"]
#    depends_on:
#    - zbalance

  conjure-det:
    << : *config
    # image: conjure_det:latest # for smaller image when running separate
    privileged: true
    volumes:
    - /dev/net/tun:/dev/net/tun #tun driver interface
    - /dev/hugepages:/dev/hugepages # zbalance_ipc
    - /var/lib/conjure:/var/lib/conjure # config
    command: ["bash", "-c", "sleep 10 && /opt/conjure/bin/start_detector.sh"]

  conjure-app:
    << : *config
    # image: conjure_app:latest # for smaller image when running separate
    privileged: true
    volumes:
    - /dev/net/tun:/dev/net/tun #tun driver interface
    - /dev/hugepages:/dev/hugepages # zbalance_ipc
    - /var/lib/conjure:/var/lib/conjure # config
    command: ["bash", "-c", "sleep 10 && /opt/conjure/bin/start_application.sh"]
